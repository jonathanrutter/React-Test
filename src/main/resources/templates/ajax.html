<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Dynamic AJAX Page</title>
        
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.css">
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css" integrity="sha384-5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz" crossorigin="anonymous">
		<link rel="stylesheet" href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.min.css" />
        <link rel="stylesheet" href="/css/shards.min.css">
		<link rel="stylesheet" href="/css/test.css">
		
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"> </script>
		<script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"> </script>
		
		<script>

			function addEmployee(){
				
				let formArray = $(myForm).serializeArray();
				
			    var returnArray = {};
			    for (var i = 0; i < formArray.length; i++){
			        returnArray[formArray[i]['name']] = formArray[i]['value'];
			    }
			    let stringArray = JSON.stringify(returnArray);
			    
			    $.ajax({
			        "url": "/rest/employees",
			        "method": "POST",
			        "headers": {
			            "Content-Type": "application/json"
			        },
			        "data": stringArray,
			        success: function (result) {
			        	setTableData(result);
			        	clearForm();
			        },
			        error : function (){
			            alert("error")
			        }
			    })
			};
		
			function clearForm() {
				// this gets an array of all components with the id 'myForm'
				$('#myForm')[0].reset();
			};
			
			function deleteEmployee(id){
			    $.ajax({
			        "url": "/rest/employees/"+id,
			        "method": "DELETE",
			        "headers": {
			        },
			        success: function (result) {
			        	setTableData(result);
			        },
			        error : function (){
			            alert("error")
			        }
			    })
			};
		
			function setTableData(dataArray){
				var table = $('#myTable').DataTable();
				 
				table
					.clear();
				table
					.rows
					.add(dataArray)
					.draw();
			};

			function initialiseTable(dataArray){
			    let table = $('#myTable').DataTable({
			    	responsive: true,
			    	data: dataArray,
			    	columns: [
			    		{ data: "id" },
			    		{ data: "name" },
			    		{ data: "email" },
			    		{ data: "role" },
			            {
			                data: null,
			                className: "dt-center",
			                orderable: false,
			                render: function (data, type, row) {
			                	return '<button onclick="deleteEmployee('+data.id+')" class="btn btn-primary"><i class="fa fa-trash"/></button>'
			                }
			            }
			    	]
			    });
			}

			$(document).ready( function () {
			    
			    $.ajax({
			        "url": "/rest/employees",
			        "method": "GET",
			        "headers": {
			            "Content-Type": "application/json"
			        },
			        success: function (result) {
			        	initialiseTable(result);
			        },
			        error : function (){
			            alert("error loading data into table")
			        }
			    })

			} );
			
			$('#spinner-div').hide();
			
			$(document)
				.ajaxStart(function () {
					$('#spinner-div').show();
				})
				.ajaxStop(function () {
					//Adding an extra second just so we can see loading spinner
					setTimeout(function() { 
						$('#spinner-div').hide();
				    }, 1000);
				});
			
		</script>
	</head>
	<body>
		<div id="spinner-div" role="status">
			<div class="spinner-inner">
				<div class="spinner-grow text-success" style="width: 3rem; height: 3rem;">
				</div>
				<div class="spinner-grow text-danger" style=" width: 4rem; height: 4rem;">
				</div>
				<div class="spinner-grow text-warning" style=" width: 4rem; height: 4rem;">
				</div>
				<div class="spinner-grow text-info" style="width: 3rem; height: 3rem;">
				</div>
				<br>
				Loading...
			</div>
		</div>
		
        <div class="container my-5">
	        <div class="row">
				<div class="col-md-6">
	           		<a href="/index" class="btn btn-primary">
	           			<i class="fas fa-home ml-2"></i>
	           			Home
	           		</a>
	        	</div>
	        </div>
	        <br>
	        <h2 class="my-5">Employees</h2>
            <p>By using the XMLHttpRequest we can dynamically update the webpage without reloading the entire page.
            <br/>The XMLHttpRequest object can be used to exchange data with a server behind the scenes. This means that it is possible to update parts of a web page, without reloading the whole page.
            Here we use JQuery $ajax calls to use the XMLHttpRequest to GET, POST and DELETE Employees.</p>
            Note: for the purpose of illustration of the loading spinner the spinner is left on screen and extra 1000ms.
            <div class="row">
	        
			<table id="myTable" class="display" style="width:100%">
		        <thead>
		            <tr>
		                <th>Id</th>
		                <th>Name</th>
		                <th>Email</th>
		                <th>Role</th>
						<th>Delete</th>
		            </tr>
		        </thead>
		    </table>
    		
            <div class="row">
				<div class="col-md-6">
				    <form id="myForm" method="post">
				      
				      	<div class="form-group col-md-6">
				      		<label for="name" class="col-form-label">Name</label>
				      		<input type="text" class="form-control" id="name" name="name" placeholder="Name">
				      	</div>
				      	<div class="form-group col-md-6">
				      		<label for="email" class="col-form-label">Email</label>
				      		<input type="email" class="form-control" id="email" name="email" placeholder="Email">
				      		<br>Email is not validated automatically as a form is not submitted
				      	</div>
				      	<div class="form-group col-md-6">
				      		<label for="role" class="col-form-label">Role</label>
				      		<input type="text" class="form-control" id="role" name="role" placeholder="Role">
				      	</div>
					</form>
					<div class="form-group col-md-6">
						<button onclick="addEmployee()" class="btn btn-primary"><i class="fas fa-user-plus ml-2">Add Employee </i></button>
					</div>
				</div>
			</div>
    	</div>
    		
    </body>
</html>